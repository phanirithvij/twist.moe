<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
	<link rel="stylesheet" type="text/css" href="css/styles.css"/>
	<title>
		Twist mirror website
	</title>
</head>
<body>
<section class="main">
<header>
	
</header>
<main align="center" id="mainthing">
<div id="container">
<button onclick="toggleSearch()" title="Toggle Search bar kitsu and Twist" id="tsearch">
	<
</button>&nbsp;
<div id="twis">
<form>
<input type="text" name="anisearch" placeholder="SEARCH" autocomplete="off"/><br>
	
</form>&nbsp;
<nav>
	<ul class="suggestions">

	</ul>
</nav>
</div>
<div id="kits">
<form>
<input id="ktype" type="text" name="kitssearch" placeholder="KITSU" autocomplete="off" /><br>
</form>
<nav>
	<ul class="suggestions2">

	</ul>
</nav>
</div>
</div>
</main>
<div id="useritems">
	<ul>
		<li class="items" onclick="changeName()">
			Change Name
		</li>
		<br>
		<li class="items">
			Settings
		</li>
		<br>
		<li onclick="forgetUser()" class="items">
			Logout
		</li>
		<br>
	<div id="settings">
			<?xml version="1.0" encoding="iso-8859-1"?>
<!-- Generator: Adobe Illustrator 19.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
	<svg x="0px" y="0px"
		 viewBox="0 0 54 54" style="enable-background:new 0 0 54 54;" xml:space="preserve">
	<g>
	<path d="M51.22,21h-5.052c-0.812,0-1.481-0.447-1.792-1.197s-0.153-1.54,0.42-2.114l3.572-3.571
		c0.525-0.525,0.814-1.224,0.814-1.966c0-0.743-0.289-1.441-0.814-1.967l-4.553-4.553c-1.05-1.05-2.881-1.052-3.933,0l-3.571,3.571
		c-0.574,0.573-1.366,0.733-2.114,0.421C33.447,9.313,33,8.644,33,7.832V2.78C33,1.247,31.753,0,30.22,0H23.78
		C22.247,0,21,1.247,21,2.78v5.052c0,0.812-0.447,1.481-1.197,1.792c-0.748,0.313-1.54,0.152-2.114-0.421l-3.571-3.571
		c-1.052-1.052-2.883-1.05-3.933,0l-4.553,4.553c-0.525,0.525-0.814,1.224-0.814,1.967c0,0.742,0.289,1.44,0.814,1.966l3.572,3.571
		c0.573,0.574,0.73,1.364,0.42,2.114S8.644,21,7.832,21H2.78C1.247,21,0,22.247,0,23.78v6.439C0,31.753,1.247,33,2.78,33h5.052
		c0.812,0,1.481,0.447,1.792,1.197s0.153,1.54-0.42,2.114l-3.572,3.571c-0.525,0.525-0.814,1.224-0.814,1.966
		c0,0.743,0.289,1.441,0.814,1.967l4.553,4.553c1.051,1.051,2.881,1.053,3.933,0l3.571-3.572c0.574-0.573,1.363-0.731,2.114-0.42
		c0.75,0.311,1.197,0.98,1.197,1.792v5.052c0,1.533,1.247,2.78,2.78,2.78h6.439c1.533,0,2.78-1.247,2.78-2.78v-5.052
		c0-0.812,0.447-1.481,1.197-1.792c0.751-0.312,1.54-0.153,2.114,0.42l3.571,3.572c1.052,1.052,2.883,1.05,3.933,0l4.553-4.553
		c0.525-0.525,0.814-1.224,0.814-1.967c0-0.742-0.289-1.44-0.814-1.966l-3.572-3.571c-0.573-0.574-0.73-1.364-0.42-2.114
		S45.356,33,46.168,33h5.052c1.533,0,2.78-1.247,2.78-2.78V23.78C54,22.247,52.753,21,51.22,21z M52,30.22
		C52,30.65,51.65,31,51.22,31h-5.052c-1.624,0-3.019,0.932-3.64,2.432c-0.622,1.5-0.295,3.146,0.854,4.294l3.572,3.571
		c0.305,0.305,0.305,0.8,0,1.104l-4.553,4.553c-0.304,0.304-0.799,0.306-1.104,0l-3.571-3.572c-1.149-1.149-2.794-1.474-4.294-0.854
		c-1.5,0.621-2.432,2.016-2.432,3.64v5.052C31,51.65,30.65,52,30.22,52H23.78C23.35,52,23,51.65,23,51.22v-5.052
		c0-1.624-0.932-3.019-2.432-3.64c-0.503-0.209-1.021-0.311-1.533-0.311c-1.014,0-1.997,0.4-2.761,1.164l-3.571,3.572
		c-0.306,0.306-0.801,0.304-1.104,0l-4.553-4.553c-0.305-0.305-0.305-0.8,0-1.104l3.572-3.571c1.148-1.148,1.476-2.794,0.854-4.294
		C10.851,31.932,9.456,31,7.832,31H2.78C2.35,31,2,30.65,2,30.22V23.78C2,23.35,2.35,23,2.78,23h5.052
		c1.624,0,3.019-0.932,3.64-2.432c0.622-1.5,0.295-3.146-0.854-4.294l-3.572-3.571c-0.305-0.305-0.305-0.8,0-1.104l4.553-4.553
		c0.304-0.305,0.799-0.305,1.104,0l3.571,3.571c1.147,1.147,2.792,1.476,4.294,0.854C22.068,10.851,23,9.456,23,7.832V2.78
		C23,2.35,23.35,2,23.78,2h6.439C30.65,2,31,2.35,31,2.78v5.052c0,1.624,0.932,3.019,2.432,3.64
		c1.502,0.622,3.146,0.294,4.294-0.854l3.571-3.571c0.306-0.305,0.801-0.305,1.104,0l4.553,4.553c0.305,0.305,0.305,0.8,0,1.104
		l-3.572,3.571c-1.148,1.148-1.476,2.794-0.854,4.294c0.621,1.5,2.016,2.432,3.64,2.432h5.052C51.65,23,52,23.35,52,23.78V30.22z"/>
	<path d="M27,18c-4.963,0-9,4.037-9,9s4.037,9,9,9s9-4.037,9-9S31.963,18,27,18z M27,34c-3.859,0-7-3.141-7-7s3.141-7,7-7
		s7,3.141,7,7S30.859,34,27,34z"/>
	</g>
	</svg>

	</div>
	</ul>
</div>
<footer id='myfoot'>
	<ul id="welcome">
	</ul>
	<button id="foothide">V</button>
</footer>
</section>
<section id="play" style="/*display: none;*/">
	<div id="player">
	<div id="videosrc">
		<!--
		Display Lastplayed at startup
		Or Random if a random video
		or Anime name followed by episode number if not above cases
		-->
	</div>
	<div id="playercon">
		<video src="/ug/ug2k17/cse/phani.rithvij/Downloads/Kissanime/hunterxhunter2011/Hunter_x_Hunter_(2011)_(Sub)_Episode_060.mp4" style="height: auto;" id="myvid" controls=""></video>
	</div>
	
	<div id="animedata">
			<div id="episodenav">
				<img id="poster" src=""/>
			</div>
			<div id="description"></div>
	</div>
	
	</div>
</section>
</body>
<script type="text/javascript" src="twistlinks.json"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js">
	//TO GETJSONS from kitsu.io website which is like Myanimelist with no authenication 
</script>
<script type="text/javascript" src="kitsu.js"></script>
<script type="text/javascript" src="search.js"></script>

<script type="text/javascript">
	//Video scripts 
	//video.js

	/*
	user stores user's name
	and lastplayed anime name
	and lastplayed video src 
	*/
	var currAni = {name:"",title:""};
	var username = '';
	var run = true;
	let mousedown = false;
	const body = document.body;
	const datani = document.querySelector('#animedata');
	const desc = document.querySelector('#description');
	const poster = document.querySelector('#poster');
	const heading = document.querySelector('#videosrc');
	const sect = document.querySelector('#play');
	const foot = document.querySelector('#myfoot');
	const video = document.querySelector('#myvid');
	const divvid = document.querySelector('#playercon');
	divvid.style.height = '50%';
	datani.style.height = '50%';
	
	var oldh = parseInt(divvid.style.height);
	var oldw = parseInt(divvid.style.width);
	
	function changeSize(id,w,h) {
		var el = document.querySelector(id);
		el.style.height = h + "px";
		el.style.width = w + "px";
	}

	function touchhandler(e) {
	e.preventDefault();
	oldh = e.offsetY -4;
	oldw = e.offsetX -4;
	changeSize('#myvid',oldw,oldh);
	}

	var user = {
		"lastplayed": "",
		"lastanime": "",
		"lastbackimg": "",
		"lastposter":"",
		"name": "",
		"lastdesc":""
	};
	
	function recentVid(){
	return  video.src || JSON.parse(localStorage.getItem('user')).lastplayed;
	}
	
	function toggleVid(){
		if(video.paused){
		video.play();
		}else{
			video.pause();
		}
	}
	
	function nextVid(){
		
	}
	
	function prevVid(){
	
	}

	function randomVid(){
		//make it
		return video.src;
		// Return episode 1 of a random anime;
	}

	function changVidkits(ani,slug){
		if(slug != null && slug != undefined){
			console.log("SLUG FROM changVidkits()");
			console.log(slug);
			var link = '';
			link = kitapi + 'anime' + '?filter[text]' + slug;
			console.log(link);
			resp = $.getJSON(link,(data)=>{
				//search exactly for matching slug(data)
				
				searchSlug(data,slug);

				console.log("DATA BASED ON SLUG");
				console.log(data);
			});
		}
		for (var i=0;i<=anime.length;i++){
		if(anime[i] != undefined && anime[i].name == ani)
		{
			currAni = anime[i];
			localStorage.setItem('curranime',JSON.stringify(currAni));
			//change video src 
			//get it from twist.moe
			video.src = currAni[1];
			
			//set user lastanime and lastplayed
			user.lastanime = currAni.name;
			var lastplayed = video.src;
			user.lastplayed = lastplayed;
			localStorage.setItem('user',JSON.stringify(user));

			
		}

		}
		//console.log(currAni);

	}

	function searchSlug(data,slug){
			//slug search in kitsu data just recieved
			//for exact match
		console.log('data,slug,recieved');
		console.log(slug,data);
		const testdata = data;
		const testslug = slug;
		for (var i=0;i<testdata.data.length;i++){
			if(testdata.data[i].attributes.slug == testslug){
			gotit = testdata.data[i];
			
			//got it contains exact anime with slug
			console.log('gotit');
			console.log(gotit);

			//set descripton
			desc.innerHTML = `${gotit.attributes.synopsis}`;
			user.lastdesc = gotit.attributes.synopsis;
			
			//change background and the poster
			body.style.backgroundImage = `url(${gotit.attributes.coverImage.original})`;
			user.lastposter = gotit.attributes.posterImage.tiny;
			poster.src = user.lastposter;
			user.lastbackimg = gotit.attributes.coverImage.original;
			localStorage.setItem('user',JSON.stringify(user));
			heading.innerHTML = `${gotit.attributes.titles.en}`;
			}
		}
	}

</script>
<script type="text/javascript">
	//Set user and lastplayed manager 
	//user.js
	const divuser = document.querySelector('#useritems');
	//divuser.style.opacity = '0';
	function setUser(){
		
	if(localStorage.getItem('curranime') === null){
	localStorage.setItem('curranime',JSON.stringify(currAni));
	}
	if(localStorage.getItem('user') === null){
	localStorage.setItem('user',JSON.stringify(user));
	}
	
	if(JSON.parse(localStorage.getItem('curranime')).name == ""){
		const welcome = document.querySelector('#welcome');
		welcome.innerHTML = 'Welcome to our website!!' ;
	}

	if(JSON.parse(localStorage.getItem('user')).name === "" || JSON.parse(localStorage.getItem('user')).name === null || JSON.parse(localStorage.getItem('user')).name === undefined){
	username = prompt('What should we call you?');
	user.name = username;
	localStorage.setItem('user',JSON.stringify(user));
	}
		username = JSON.parse(localStorage.getItem('user')).name;
		video.src = recentVid();
		const welcome = document.querySelector('#welcome');
		welcome.innerHTML = 'Welcome ' + username;
		setTimeout(userNav,1000);
		var lastbackimg = JSON.parse(localStorage.getItem('user')).lastbackimg;
		body.style.backgroundImage = `url(${lastbackimg};`;
		
		user = JSON.parse(localStorage.getItem('user'));
	}

	function changeName(){
		var newname = prompt('Enter your new name');
		if(newname != null){
		user.name = newname;
		localStorage.setItem('user',JSON.stringify(user));
		const welcome = document.querySelector('#welcome');
		welcome.innerHTML = 'Username changed ' + user.name;
		setTimeout(userNav,1000);
		}
	}

	function forgetUser(){
		//Dangerous 
		confirm('Click Ok to make us forget you') && localStorage.clear();
	}

	function userNav(){
		const welcome = document.querySelector('#welcome');
		welcome.innerHTML = `
		<li>
		<a href="#" onclick="dispNav()">${user.name}</a>
		</li>`;
	}
	function dispNav(){
		//div.classList.toggle("show");
		if(divuser.style.visibility == "hidden" ){
		divuser.style.visibility = "visible";
		}else{
		divuser.style.visibility = "hidden";
		}

		//console.log('show items');
	}
	function setVideo(){
		if(localStorage.getItem('user') === null){
			video.src = randomVid();
		}
		else{
		var lastplayed = JSON.parse(localStorage.getItem('user')).lastplayed;
			
		if(lastplayed != ""){
		video.src = lastplayed;
		heading.innerHTML = `<h5>Last Played</h5>`;
		var lastanime = JSON.parse(localStorage.getItem('user')).lastanime;
		heading.innerHTML += `<h5>${lastanime}</h5>`;
		setTimeout(()=>{
		currAni = JSON.parse(localStorage.getItem('curranime'));
		heading.innerHTML = currAni.title;
		desc.innerHTML = user.lastdesc;
		},2000);
		}
		else{
		video.src = randomVid();
		user.lastplayed = video.src;
		heading.innerHTML = `<h5>Random</h5>`;
		localStorage.setItem('user',JSON.stringify(user));
		}
		
		}
	}
</script>

<script type="text/javascript">
	//Event listeners 
	//events.js

	//search Kitsu
	//after user stops typing after 1sec doneTyping executes
	var typingTimer;                //timer identifier
	var doneTypingInterval = 1000;  //time in ms (1 seconds)
	//on keyup, start the countdown
	$('#ktype').keyup(function(){
	    clearTimeout(typingTimer);
	    if ($('#ktype').val()) {
	        typingTimer = setTimeout(doneTyping, doneTypingInterval);
	    }
	});
	//search Kitsu

	//search twist
	seart.addEventListener('change', displayMatches);
	seart.addEventListener('keyup', displayMatches);
	//search twist
	
	
	//search kitsu
	/*
	TODO:
			make a loading thing appear
	*/
	//sears.addEventListener('change', kitsSearch);
	//sears.addEventListener('keyup', kitsSearch);
	//search kitsu
	

	//usersetting
	window.addEventListener('load',setUser,false);
	window.addEventListener('load',setVideo,false);
	//usersetting

	//display footer or video
	/*
	sect.addEventListener('click',()=>{
		foot.style.zIndex = 6;
		sect.style.zIndex = 7;
	});
	foot.addEventListener('click',()=>{
		foot.style.zIndex = 7;
		sect.style.zIndex = 6;
	})
	*/
	//display footer or video

	//video play,pause
/*	video.addEventListener('play',()=>{
		user.lastplayed = video.src;
		localStorage.setItem('user',JSON.stringify(user));
	},false);//setVideo);
*/
	video.addEventListener('click',toggleVid,false);
	//video play,pause

	//video size stuff
	video.addEventListener('play',()=>{ run = false;console.log(run) });
	video.addEventListener('pause',()=>{ run = true ;console.log(run)});
	//divvid.addEventListener('click', run && touchhandler,false);
	divvid.addEventListener('mousemove', (e) => run && mousedown && touchhandler(e),false);
	sect.addEventListener('mousedown', () => {mousedown = true;console.log("mousedown = " + mousedown)} );
	sect.addEventListener('mouseup', () => {mousedown = false;console.log("mousedown = " + mousedown)});
	//video size stuff

	//bug kitsu opens up for no reason



</script>




</html>